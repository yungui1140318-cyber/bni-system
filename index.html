<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²è²´äººè„ˆç®¡ç†ç³»çµ± (ç›´é€£ç‰ˆ)</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-color: #cf2e2e; --bg-color: #f0f2f5; --text-color: #333; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg-color); height: 100vh; display: flex; flex-direction: column; color: var(--text-color); }

        /* --- Identity Overlay (ç™»å…¥å±¤) --- */
        #identity-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .box { background: white; padding: 30px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .box h2 { margin-top: 0; color: #333; }
        .box p { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
        .box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 8px; text-align: center; font-size: 1.1rem; box-sizing: border-box; outline: none; }
        .box input:focus { border-color: var(--primary-color); }
        .box button { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .box button:active { transform: scale(0.98); }
        
        /* --- Header & Tabs --- */
        header { background: var(--primary-color); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.1rem; letter-spacing: 1px; }
        .user-tag { font-size: 0.85rem; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 20px; font-weight: bold; }

        .tabs-container { background: #fff; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; }
        .tabs { display: flex; background: #f0f0f0; border-radius: 50px; padding: 5px; max-width: 600px; margin: 0 auto; }
        .tab-btn { flex: 1; padding: 10px; text-align: center; border-radius: 40px; cursor: pointer; font-weight: bold; color: #666; font-size: 0.95rem; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-color); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- Main Content Area --- */
        .container { padding: 15px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box; display: none; overflow-y: auto; flex-grow: 1; }
        .container.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 81 Grid Styles --- */
        .mandala { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; padding-bottom: 20px; }
        .sub-grid { display: grid; grid-template-columns: repeat(3, 1fr); background: #fff; border: 1px solid #ccc; aspect-ratio: 1/1; }
        /* Center Grid Highlight */
        .sub-grid:nth-child(5) { border: 2px solid var(--primary-color); box-shadow: 0 0 15px rgba(207, 46, 46, 0.15); z-index: 5; }
        
        .cell { border: 1px solid #eee; display: flex; align-items: center; justify-content: center; position: relative; background: #fff; overflow: hidden; }
        
        .editable-cell {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 0.85rem; outline: none; padding: 2px;
            word-break: break-all; cursor: text;
        }
        .editable-cell:focus { background: #fffde7; }
        
        .core .editable-cell { background: #f5f5f5; font-weight: bold; color: #444; }
        .master .editable-cell { background: var(--primary-color); color: white; font-weight: bold; font-size: 1rem; }
        .master .editable-cell:empty::before { content: "æ ¸å¿ƒ\aç”¢æ¥­"; white-space: pre; opacity: 0.7; }
        .master .editable-cell:focus { background: #fff; color: #000; }

        /* --- Radar (Matches) --- */
        .radar { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #90caf9; }
        .match-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .match-tag { background: #1565c0; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; }

        /* --- CRM Styles --- */
        .crm-form { background: white; padding: 15px; border-radius: 8px; border-top: 4px solid var(--primary-color); margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.95rem; min-width: 120px; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .btn-main:hover { background: #b02323; }
        
        table { width: 100%; border-collapse: collapse; background: white; font-size: 0.9rem; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #555; font-weight: bold; }
        .tag { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: bold; display: inline-block; }
        
        /* Loading Spinner */
        #loading { position: fixed; top: 15px; right: 15px; background: rgba(0,0,0,0.8); color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; display: none; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        
        @media (max-width: 768px) {
            .mandala { gap: 10px; }
            .sub-grid { min-height: 250px; } /* Mobile height fix */
            .editable-cell { font-size: 1rem; } /* Larger text on mobile */
        }
    </style>
</head>
<body>

<script>
    // ğŸŸ¢ ä½ çš„è³‡æ–™åº«è¨­å®š
    const SUPABASE_URL = 'https://htlywcaudjfnneaoikgz.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0bHl3Y2F1ZGpmbm5lYW9pa2d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MjExOTIsImV4cCI6MjA4NjI5NzE5Mn0.h5lO8qbOBaQD1vqNwyFmLAGjut6afZN4mDrgmPoxCUg';
</script>

<div id="loading">è³‡æ–™åŒæ­¥ä¸­...</div>

<div id="identity-overlay">
    <div class="box">
        <h2>é›²è²´äººè„ˆç³»çµ±</h2>
        <p>è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“åä»¥åŒæ­¥è³‡æ–™</p>
        <input type="text" id="userName" placeholder="ä¾‹å¦‚ï¼šå³å¿—ç’˜" onkeypress="if(event.key==='Enter') initSystem()">
        <button onclick="initSystem()">é–‹å§‹ä½¿ç”¨</button>
    </div>
</div>

<header>
    <h1>é›²è²´äººè„ˆåº«</h1>
    <span class="user-tag" id="displayUser">è¨ªå®¢</span>
</header>

<div class="tabs-container">
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('grid')">ç”¢æ¥­éˆ 81 å®®æ ¼</div>
        <div class="tab-btn" onclick="switchTab('crm')">äººè„ˆè®Šç¾è¡¨</div>
    </div>
</div>

<div id="grid-view" class="container active">
    <div class="mandala" id="mandala"></div>
    <div class="radar" id="radar" style="display:none;">
        <h3 style="margin:0 0 10px 0; color:#1565c0; font-size:1rem;">ğŸ“¡ äººè„ˆè³‡æºé›·é” (è‡ªå‹•æœå°‹å…¨æœƒ)</h3>
        <div id="radar-content"></div>
    </div>
</div>

<div id="crm-view" class="container">
    <div class="crm-form">
        <div class="row">
            <input id="cName" placeholder="äººè„ˆå§“å (ä¾‹å¦‚: ç‹å°æ˜)">
            <input id="cIndustry" placeholder="ç”¢æ¥­é¡åˆ¥ (ä¾‹å¦‚: å¾‹å¸«)">
        </div>
        <div class="row">
            <select id="cTrust">
                <option value="A">A - é«˜ä¿¡ä»»</option>
                <option value="B">B - ç†Ÿè­˜</option>
                <option value="C">C - æ™®é€š</option>
                <option value="D">D - é™Œç”Ÿ</option>
            </select>
            <select id="cNeed">
                <option value="X">X - æ€¥éœ€</option>
                <option value="Y">Y - æœ‰éœ€æ±‚</option>
                <option value="Z">Z - æœªçŸ¥</option>
            </select>
        </div>
        <button class="btn-main" onclick="addContact()">æ–°å¢äººè„ˆè³‡æº</button>
    </div>
    
    <div style="overflow-x:auto">
        <table>
            <thead><tr><th>ç­–ç•¥</th><th>å§“å/ç”¢æ¥­</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="contact-list"></tbody>
        </table>
    </div>
</div>

<script>
    // --- 1. åˆå§‹åŒ– Supabase ---
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let currentMember = null;
    let gridData = {}; 
    let myNeeds = [];

    // --- 2. ç³»çµ±å•Ÿå‹• (èº«åˆ†ç¢ºèª) ---
    async function initSystem() {
        const nameInput = document.getElementById('userName');
        const name = nameInput.value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“å");

        document.getElementById('loading').style.display = 'block';

        // æŸ¥è©¢æ˜¯å¦å·²æœ‰æ­¤æœƒå“¡
        let { data: members, error } = await db.from('members').select('*').eq('name', name).single();

        if (error && error.code !== 'PGRST116') { // PGRST116 æ˜¯ "æŸ¥ç„¡è³‡æ–™" çš„ä»£ç¢¼
             alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key");
             document.getElementById('loading').style.display = 'none';
             return;
        }

        if (!members) {
            // æ²’é€™å€‹äºº -> è‡ªå‹•å»ºç«‹æ–°æœƒå“¡
            const { data: newMember, error: createError } = await db.from('members').insert({ name }).select().single();
            if (createError) {
                alert("å»ºç«‹æœƒå“¡å¤±æ•—ï¼š" + createError.message);
                document.getElementById('loading').style.display = 'none';
                return;
            }
            currentMember = newMember;
        } else {
            currentMember = members;
        }

        // UI è¨­å®š
        document.getElementById('displayUser').innerText = currentMember.name;
        document.getElementById('identity-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('identity-overlay').style.display = 'none', 500);

        // è¼‰å…¥è³‡æ–™
        renderGridStructure(); // å…ˆæŠŠæ ¼å­ç•«å‡ºä¾†
        await loadGrid();
        await loadContacts();
        document.getElementById('loading').style.display = 'none';
    }

    // --- 3. 81 å®®æ ¼é‚è¼¯ ---
    function renderGridStructure() {
        const el = document.getElementById('mandala');
        if(el.innerHTML) return; 

        for(let g=0; g<9; g++) {
            let sub = document.createElement('div'); sub.className='sub-grid';
            for(let c=0; c<9; c++) {
                let cell = document.createElement('div'); 
                let isM = (g===4 && c===4), isC = (c===4);
                cell.className = `cell ${isM?'master':''} ${isC?'core':''}`;
                
                let div = document.createElement('div');
                div.className = 'editable-cell';
                div.contentEditable = true;
                let id = `g${g}-c${c}`;
                div.dataset.id = id; // ç”¨ dataset å­˜ ID
                
                // å”¯è®€è¨­å®šï¼šå¤–åœçš„ä¸­å¿ƒæ ¼ (å› ç‚ºå®ƒå€‘æ˜¯åŒæ­¥éä¾†çš„)
                if(g!==4 && c===4) div.contentEditable = false; 

                // å¤±ç„¦å­˜æª”äº‹ä»¶
                div.onblur = (e) => {
                    let val = e.target.innerText;
                    if(val !== (gridData[id] || '')) {
                        saveCell(id, val);
                    }
                };

                cell.appendChild(div);
                sub.appendChild(cell);
            }
            el.appendChild(sub);
        }
    }

    async function loadGrid() {
        const { data } = await db.from('user_grids').select('*').eq('member_id', currentMember.id);
        if (data) {
            data.forEach(item => {
                gridData[item.grid_index] = item.content;
                // å¡«å…¥ DOM
                let el = document.querySelector(`.editable-cell[data-id="${item.grid_index}"]`);
                if(el) el.innerText = item.content;
            });
        }
        syncGridVisuals(); // è™•ç†åŒæ­¥é¡¯ç¤º
        checkMatches();    // è§¸ç™¼é…å°
    }

    async function saveCell(index, content) {
        // 1. æœ¬åœ°æ›´æ–°
        gridData[index] = content;
        
        // 2. è¦–è¦ºåŒæ­¥ (å¦‚æœæ”¹çš„æ˜¯ä¸­é–“é‚£æ ¼ï¼Œè¦åŒæ­¥åˆ°å¤–åœ)
        if(index.startsWith('g4-')) {
            syncGridVisuals();
            checkMatches(); // æ ¸å¿ƒéœ€æ±‚æ”¹è®Šï¼Œé‡æ–°é…å°
        }

        // 3. é›²ç«¯å­˜æª” (èƒŒæ™¯åŸ·è¡Œ)
        await db.from('user_grids').upsert({
            member_id: currentMember.id,
            grid_index: index,
            content: content
        }, { onConflict: 'member_id, grid_index' });
    }

    const mapCenterToOuter = { 0:0, 1:1, 2:2, 3:3, 5:5, 6:6, 7:7, 8:8 };
    
    function syncGridVisuals() {
        // æŠŠä¸­é–“ä¹å®®æ ¼ (g4-c0...c8) çš„å€¼ï¼ŒåŒæ­¥åˆ°å¤–åœå°æ‡‰æ ¼å­çš„ä¸­å¿ƒ (gx-c4)
        for(let i=0; i<9; i++) {
            if(i === 4) continue; // ä¸­é–“çš„æ ¸å¿ƒä¸éœ€åŒæ­¥
            let centerVal = gridData[`g4-c${i}`] || '';
            let targetGridIdx = mapCenterToOuter[i];
            
            // æ›´æ–°æ•¸æ“š
            let targetId = `g${targetGridIdx}-c4`;
            // é€™è£¡æˆ‘å€‘ä¸å­˜å…¥ DBï¼Œåªåšè¦–è¦ºåŒæ­¥ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥é¸æ“‡å­˜å…¥ DB
            // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘åªåšè¦–è¦ºå‘ˆç¾
            let el = document.querySelector(`.editable-cell[data-id="${targetId}"]`);
            if(el) el.innerText = centerVal;
        }
    }

    // --- 4. äººè„ˆé…å°é›·é” (Matching Logic) ---
    async function checkMatches() {
        // 1. æŠ“å–æˆ‘çš„éœ€æ±‚ (ä¸­é–“ä¹å®®æ ¼çš„å­—)
        myNeeds = [];
        for(let i=0; i<9; i++) {
            let val = gridData[`g4-c${i}`];
            if(val && val.trim() !== '' && val !== 'æ ¸å¿ƒ\nç”¢æ¥­') myNeeds.push(val);
        }

        if(myNeeds.length === 0) {
            document.getElementById('radar').style.display = 'none';
            return;
        }

        document.getElementById('radar').style.display = 'block';
        const radarDiv = document.getElementById('radar-content');
        radarDiv.innerHTML = '<small style="color:#666">æ­£åœ¨æœå°‹å…¨åˆ†æœƒè³‡æ–™åº«...</small>';

        let html = '';
        let foundAny = false;
        
        // 2. å» user_contacts æœå°‹æ‰€æœ‰å«æœ‰é€™äº›é—œéµå­—çš„ç”¢æ¥­
        // æ³¨æ„ï¼šé€™è£¡æœå°‹çš„æ˜¯ "åˆ¥äºº" çš„äººè„ˆ
        for (let need of myNeeds) {
            const { data } = await db.from('user_contacts')
                .select('*')
                .neq('member_id', currentMember.id) // æ’é™¤è‡ªå·±
                .ilike('industry', `%${need}%`) // æ¨¡ç³Šæœå°‹
                .limit(3); // æ¯å€‹éœ€æ±‚æœ€å¤šé¡¯ç¤º 3 ç­†

            if(data && data.length > 0) {
                foundAny = true;
                data.forEach(c => {
                    // æ ¹æ“šä¿¡ä»»åº¦çµ¦é¡è‰²
                    let trustColor = c.trust_level === 'A' ? '#d32f2f' : '#666';
                    html += `
                        <div class="match-item">
                            <div>
                                <span class="match-tag">éœ€æ±‚: ${need}</span>
                                <span style="font-weight:bold; color:#333;">${c.owner_name}</span> 
                                <span style="font-size:0.85rem">æœ‰ ${c.industry} è³‡æº</span>
                            </div>
                            <div style="text-align:right">
                                <div>${c.name}</div>
                                <small style="color:${trustColor}; font-weight:bold;">ä¿¡ä»»: ${c.trust_level}</small>
                            </div>
                        </div>
                    `;
                });
            }
        }
        
        if(!foundAny) {
            radarDiv.innerHTML = '<small style="color:#666">ç›®å‰è³‡æ–™åº«ä¸­æš«ç„¡ç¬¦åˆçš„å¤–éƒ¨è³‡æºã€‚</small>';
        } else {
            radarDiv.innerHTML = html;
        }
    }

    // --- 5. CRM é‚è¼¯ ---
    async function loadContacts() {
        const { data } = await db.from('user_contacts')
            .select('*')
            .eq('member_id', currentMember.id)
            .order('created_at', { ascending: false });
        
        const list = document.getElementById('contact-list');
        list.innerHTML = '';
        
        if(data) {
            data.forEach(c => {
                // é¡è‰²é‚è¼¯
                let color = '#4caf50'; // ç¶  (è§€å¯Ÿ)
                if ((c.trust_level === 'A' || c.trust_level === 'B') && (c.need_level === 'X' || c.need_level === 'Y')) {
                    color = '#f44336'; // ç´… (ç”œèœœå€)
                } else if (c.trust_level === 'C' && c.need_level === 'X') {
                    color = '#2196f3'; // è— (å»ºç«‹ä¿¡ä»»)
                } else if ((c.trust_level === 'A' || c.trust_level === 'B') && c.need_level === 'Z') {
                    color = '#ff9800'; // æ©˜ (ä¸»å‹•äº†è§£)
                }

                list.innerHTML += `
                    <tr>
                        <td><span class="tag" style="background:${color}">${c.trust_level}/${c.need_level}</span></td>
                        <td>
                            <b>${c.name}</b> <br>
                            <small style="color:#666">${c.industry}</small>
                        </td>
                        <td>
                            <button onclick="delContact('${c.id}')" style="color:#f44336; border:none; background:none; cursor:pointer; font-weight:bold; font-size:1rem;">âœ•</button>
                        </td>
                    </tr>
                `;
            });
        }
    }

    async function addContact() {
        const name = document.getElementById('cName').value;
        const ind = document.getElementById('cIndustry').value;
        if(!name || !ind) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

        document.getElementById('loading').style.display = 'block';
        
        const { error } = await db.from('user_contacts').insert({
            member_id: currentMember.id,
            owner_name: currentMember.name,
            name: name,
            industry: ind,
            trust_level: document.getElementById('cTrust').value,
            need_level: document.getElementById('cNeed').value
        });

        if(error) {
            alert("æ–°å¢å¤±æ•—");
        } else {
            document.getElementById('cName').value = '';
            document.getElementById('cIndustry').value = '';
            await loadContacts();
            // æ–°å¢äººè„ˆå¯èƒ½æœƒè§¸ç™¼åˆ¥äººçš„é…å°ï¼Œä½†é€™è£¡ä¸éœ€è¦é‡æ–°æ•´ç†è‡ªå·±çš„é…å°
        }
        document.getElementById('loading').style.display = 'none';
    }

    async function delContact(id) {
        if(!confirm("ç¢ºå®šåˆªé™¤é€™æ¢äººè„ˆï¼Ÿ")) return;
        document.getElementById('loading').style.display = 'block';
        await db.from('user_contacts').delete().eq('id', id);
        await loadContacts();
        document.getElementById('loading').style.display = 'none';
    }

    // --- é ç±¤åˆ‡æ› ---
    function switchTab(t) {
        document.getElementById('grid-view').classList.toggle('active', t==='grid');
        document.getElementById('crm-view').classList.toggle('active', t==='crm');
        const btns = document.querySelectorAll('.tab-btn');
        btns[0].classList.toggle('active', t==='grid');
        btns[1].classList.toggle('active', t==='crm');
    }

</script>
</body>
</html>